#!/usr/bin/env bash

NOTE_DIR="/Users/$USER/notes"
NOTE_TEMP_DIR="/tmp/note.list"

usage() {
  echo
  echo "usage: note <command> [<args>]"
  printf "commands:"
  printf "\n\tnew\t\tCreate a new note"
  printf "\n\tlist\t\tList notes"
  printf "\n\tfind\t\tFind notes"
  printf "\n\tedit\t\tEdit notes located by \"find\""
  printf "\n\n"
  exit 0
}

exit_arg_err() {
  usage
  exit 1
}

new() {
  local dirpath
  local filename
  local filepath

  if [[ -z "$1" ]] && [[ -d "$NOTE_DIR/misc" ]]; then
    dirpath="$NOTE_DIR/misc"
  elif [[ -z "$1" ]]; then
    dirpath="$NOTE_DIR"
  else
    dirpath="$NOTE_DIR/$1"
    [[ -d "$dirpath" ]] || mkdir -p "$dirpath"
  fi

  if [[ -z "$2" ]]; then
    filename="$(date +"%m-%d-%Y").txt"
  else
    filename="$2"
  fi

  filepath="$dirpath/$filename"
  touch "$filepath"
  $EDITOR "$filepath"
}

list() {
  ls -1 "$@"
}

find() {
  grep -ri "$@" "$NOTE_DIR"
  grep -rni "$@" "$NOTE_DIR" > "$NOTE_TEMP_DIR"
}

edit() {
  $EDITOR -q "$NOTE_TEMP_DIR"
}

help() {
  case "$1" in
    new|n)
      echo
      echo "usage: note new [<args>]"
      printf "commands:"
      printf "\n\tnote new\t\tCreate a new note in the \"misc\" dir"
      printf "\n\tnote new dir\t\tCreate a new note in an existing dir"
      printf "\n\tnote new dir name\tCreate a new note in an existing dir with \"name\""
      echo
      ;;
    *)
      usage
      ;;
  esac

}

cd "$NOTE_DIR"

case "$1" in
  new|n)
    shift ;
    new "$@"
    ;;
  list|ls|l)
    shift ;
    list "$@"
    ;;
  find|f)
    shift ;
    find "$@"
    ;;
  edit|ed|e)
    edit
    ;;
  help|h)
    shift ;
    help "$@"
    ;;
  *)
    usage
    ;;
esac

exit 0
